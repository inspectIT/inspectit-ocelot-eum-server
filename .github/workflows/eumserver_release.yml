name: Release Eum Server

on: 
    push:
        tags:
            - 'v*'

jobs:
    test_eum_server:
        uses: ./.github/workflows/eumserver_test.yml

    build_project:
      name: Build EUM Server
      runs-on: ubuntu-latest
      needs: [test_eum_server]
      steps:
        - name: Checkout code
          uses: actions/checkout@v3
        - name: Grant execute permission for gradlew
          run: chmod +x gradlew
        - name: Build project
          run: ./gradlew build
        - name: Upload build
          uses: actions/upload-artifact@v2
          with:
            name: eumserver-build
            path: out/
        
    test_release:
        name: "test release"
        runs-on: ubuntu-latest
        needs: [test_eum_server, build_project]
        steps:
            - name: Download site content
              uses: actions/download-artifact@v2
              with:
                name: eumserver-build
            - name: Archive site content
              uses: thedoctor0/zip-release@master
              with: 
                filename: test.zip
            - name: Create Github Release
              uses: actions/create-release@v1
              env:
                GITHUB_TOKEN: $ {{ GITHUB_TOKEN }}
            - name: Create release
              id: create-release
              run: gh release create ${{ github.ref }} --generate-notes
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            - name: Upload asset to github release
              uses: actions/upload-release-asset@v1
              env:
                GITHUB_TOKEN: $ {{ GITHUB_TOKEN }}
              with:
                upload_url: ${{ steps.create-release.outputs.upload_url }}
                asset_path: ./test.zip
                asset_name: test-v.zip
                asset_content_type: application/zip

    publish_docker_images:
      name: "Publish docker image"
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v3
        - name: Publish docker image
          uses: docker/build-push-action@v1
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}
            registry: docker.pkg.github.com
            repository: ${{ github.repository}}/next
            tags: latest, ${{ github.ref }}
              
              
              
              
              
              
              

              
            
    