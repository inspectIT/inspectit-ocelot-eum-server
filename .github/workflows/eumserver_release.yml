name: Release Eum Server

on: 
    push:
        tags:
            - 'v*'

jobs:
    test_eum_server:
        uses: ./.github/workflows/eumserver_test.yml

    build_and_release:
      name: Build and release EUM Server
      runs-on: ubuntu-latest
      needs: []
      steps:
        - name: Checkout code
          uses: actions/checkout@v3
        - name: Grant execute permission for gradlew
          run: chmod +x gradlew
        - name: Build project
          run: ./gradlew assemble bootJar -PbuildVersion=${{ github.ref_name }}
        - name: Add artifacts
          run: |
            mkdir artifacts
            cp build/libs/*.jar ./artifacts
        - name: Upload eumserver jar
          uses: actions/upload-artifact@v3
          with:
            name: eumserver-jar
            path: build/libs/inspectit-ocelot-eum-server-${{ github.ref_name }}.jar
        - name: Create Release
          uses: softprops/action-gh-release@v0.1.15
          with:
            tag_name: ${{ github.ref_name }}
            files: artifacts/*
            generate_release_notes: true
            token: ${{ github.token }}
            name: Version ${{ github.ref_name }}

    publish_docker_image:
      name: "Publish docker image"
      runs-on: ubuntu-latest
      needs: [build_and_release]
      steps:
        - name: Checkout
          uses: actions/checkout@v3
        - name: Download eumserver jar
          uses: actions/download-artifact@v3
          with: 
            name: eumserver-jar
            path: docker
        - name: extract jar
          run: |
            cd docker
            ls
            unzip eumserver-jar.zip
        - name: Grand execute permission for gradlew
          run: chmod +x gradlew
        - name: Build Docker Images
          run: ./gradlew dockerTag -PbuildVersion=${{ github.ref_name }}
        - name: Push Docker Images
          run: |
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
            docker push danipaniii/testing:${{ github.ref_name }}
            docker push danipaniii/testing::latest
              
              
              
              
              
              
              

              
            
    