name: Release Eum Server

on: 
    push:
        tags:
            - 'v*'

jobs:
    test_eum_server:
        uses: ./.github/workflows/eumserver_test.yml
        
    test_release:
        name: "test release"
        runs-on: ubuntu-latest
        needs: test_eum_server
        steps:
            - name: Download site content
              uses: actions/download-artifact@v2
              with:
                name: test-content
            - name: Archive site content
              uses: thedoctor0/zip-release@master
              with: 
                filename: test.zip
            - name: Create Github Release
              uses: actions/create-release@v1
              env:
                GITHUB_TOKEN: $ {{ GITHUB_TOKEN }}
            - name: Create release
              id: create-release
              run: gh release create ${{ github.ref }} --generate-notes
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            - name: Upload asset to github release
              uses: actions/upload-release-asset@v1
              env:
                GITHUB_TOKEN: $ {{ GITHUB_TOKEN }}
              with:
                upload_url: ${{ steps.create-release.outputs.upload_url }}
                asset_path: ./test.zip
                asset_name: test-v.zip
                asset_content_type: application/zip
    
              
    build_assets:
        name: "Build assets"
        runs-on: ubuntu-latest
        environment: release
        needs: [test_eum_server]
        
        steps:
            - uses: actions/checkout@v3
            - name: Grant execute permission for gradlew
              run: chmod +x gradlew
            - name: run bootJar
              run: ./gradlew assemble build.gradle
            
    publish_docker_images:
        name: "Publish docker image"
        runs-on: ubuntu-latest
        environment: release
        needs: [test_eum_server]
        
        steps:
            - uses: actions/checkout@v3
              name: Check out code
              
            - uses: mr-smithers-excellent/docker-build-push@v5
              name: Build & push Docker image
              with:
                image: danipaniii/testing
                dockerfile: ../docker/
                tags: v1, latest
                registry: docker.io
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}
              
              
              
              
              
              
              

              
            
    