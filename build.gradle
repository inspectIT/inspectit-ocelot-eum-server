plugins {
    id "org.springframework.boot" version "${springboot_version}"
    id "com.palantir.docker" version "0.21.0"
    id "org.cyclonedx.bom" version "1.7.2"
}

repositories {
    mavenCentral()
}

apply plugin: "java"
apply plugin: "io.spring.dependency-management"
apply plugin: "jacoco"

group = "rocks.inspectit.ocelot"
sourceCompatibility = "1.8"

if (!project.hasProperty("buildVersion") || project.getProperty("buildVersion").empty) {
    ext.buildVersion = "SNAPSHOT"
}

version = "$buildVersion"

task downloadBoomerangjs() {
    logger.info("Downloading Boomerangjs version {}.", boomerangVersion)
    ext.dest = new File(buildDir, "boomerang-source-${boomerangVersion}.tgz")
    outputs.files(ext.dest)
    doLast {
        def f = ext.dest
        new URL("https://registry.npmjs.org/boomerangjs/-/boomerangjs-${boomerangVersion}.tgz")
                .withInputStream { i -> f.withOutputStream { it << i } }
    }
}

task deleteBoomerangjs(type: Delete) {
    delete new File(project.buildDir, "boomerangjs-${boomerangVersion}")
}

task downloadAndExtractBoomerang(dependsOn: [deleteBoomerangjs, downloadBoomerangjs], type: Copy) {
    from tarTree(downloadBoomerangjs.dest)
    into new File(project.buildDir, "boomerangjs-${boomerangVersion}")
    filter { line -> line.replaceAll("%boomerang_version%", "${boomerangVersion}") }
}

task generateVersionFile {
    ext.versionFile = new File(project.buildDir, "eum-version.info")
    doLast {
        def currentDate = new Date().toString()
        ext.versionFile.withWriter("UTF-8") { writer ->
            writer << "$version\n$currentDate\n$boomerangVersion"
        }
    }
}

task downloadOpenTelemetryPlugin() {
    ext.dest = new File(buildDir, "boomerang-opentelemetry.js")
    outputs.files(ext.dest)
    doLast {
        def f = ext.dest
        new URL("https://github.com/NovatecConsulting/boomerang-opentelemetry-plugin/releases/download/$boomerangOpenTelemetryPluginVersion/boomerang-opentelemetry.js")
                .withInputStream { i -> f.withOutputStream { it << i } }
    }

}

bootJar {
    dependsOn generateVersionFile
    dependsOn downloadAndExtractBoomerang
    dependsOn downloadOpenTelemetryPlugin

    archivesBaseName = "inspectit-ocelot-eum-server"
    version = "${buildVersion}"

    manifest {
        attributes "Start-Class": "rocks.inspectit.oce.eum.server.EUMServerApplication"
    }

    // include version file
    from generateVersionFile.versionFile

    // include boomerang
    from("$buildDir/boomerangjs-${boomerangVersion}/package") {
        include "plugins/*.js"
        include "boomerang.js"
        into "static/boomerang"
    }

    //include boomerang opentelemetry
    from("$buildDir") {
        include "boomerang-opentelemetry.js"
        into "static/boomerang"
    }
}

cyclonedxBom {
    includeConfigs = ["runtimeClasspath"]
    schemaVersion = "1.4"
    projectType = "application"
}

test {
    useJUnitPlatform()

    testLogging {
        exceptionFormat = "full"
    }
}

dependencies {
    implementation(
            "org.springframework.boot:spring-boot-starter-web",
            "org.springframework.boot:spring-boot-starter-actuator",
            "org.springframework.boot:spring-boot-starter-validation",
            "org.springframework.boot:spring-boot-starter-security",

            // pin Prometheus client to 0.6.0 to prevent auto prefixing counter metrics with "_total"
            // see: https://github.com/prometheus/client_java/issues/640, https://github.com/prometheus/client_java/pull/653
            "io.prometheus:simpleclient:${prometheusClientVersion}",
            "io.prometheus:simpleclient_common:${prometheusClientVersion}",
            "io.prometheus:simpleclient_httpserver:${prometheusClientVersion}",

            "io.opencensus:opencensus-api:${openCensusVersion}",
            "io.opencensus:opencensus-impl:${openCensusVersion}",
            "io.opencensus:opencensus-exporter-stats-prometheus:${openCensusVersion}",

            "io.grpc:grpc-netty-shaded:1.36.1",
            "io.grpc:grpc-protobuf:1.36.1",
            "io.grpc:grpc-stub:1.36.1",
            platform("io.opentelemetry:opentelemetry-bom-alpha:${openTelemetryAlphaVersion}"),
            "io.opentelemetry:opentelemetry-proto",
            "io.opentelemetry:opentelemetry-semconv",
            platform("io.opentelemetry:opentelemetry-bom:${openTelemetryVersion}"),
            "io.opentelemetry:opentelemetry-exporter-otlp",
            "io.opentelemetry:opentelemetry-exporter-jaeger",
            "io.opentelemetry:opentelemetry-exporter-jaeger-thrift",
            "io.opentelemetry:opentelemetry-sdk",
            
            "com.fasterxml.jackson.dataformat:jackson-dataformat-yaml:2.12.5",

            "com.google.protobuf:protobuf-java:3.15.7",
            "com.google.protobuf:protobuf-java-util:3.15.7",

            "com.maxmind.geoip2:geoip2:2.12.0",
            "commons-net:commons-net:3.3",
            "org.apache.commons:commons-lang3:3.+",
            "org.apache.commons:commons-math3:3.6.1",
            "commons-io:commons-io:2.11.0",
            "org.influxdb:influxdb-java:2.15",
            "rocks.inspectit:opencensus-influxdb-exporter:1.2",

    )

    compileOnly "org.projectlombok:lombok:${lombokVersion}"
    annotationProcessor "org.projectlombok:lombok:${lombokVersion}"

    testImplementation(
            //project(":inspectit-ocelot-config"),
            "org.springframework.boot:spring-boot-starter-test",
            "io.opencensus:opencensus-impl:${openCensusVersion}",
            "org.apache.httpcomponents:httpclient:4.5.6",
            "commons-io:commons-io:2.11.0",
            "org.mockito:mockito-core:${mockitoVersion}",
            "org.junit.jupiter:junit-jupiter-api:5.7.2",
            "org.awaitility:awaitility:3.1.5",
            "org.mockito:mockito-junit-jupiter:2.23.0",
            "org.testcontainers:testcontainers:1.15.2",
            "org.testcontainers:junit-jupiter:1.15.2",

            // ServerExtension
            "com.linecorp.armeria:armeria-junit5:1.14.1",
            "com.linecorp.armeria:armeria-grpc-protocol:1.14.1",

            "io.opentelemetry:opentelemetry-semconv:1.20.0-alpha",

            // for docker test containers
            "org.testcontainers:testcontainers:1.16.3",
            "org.testcontainers:junit-jupiter:1.16.3",

    )

    testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine:5.7.2"
}

task copyServerJar(type: Copy) {
    dependsOn bootJar
    from("${buildDir}/libs/inspectit-ocelot-eum-server-${version}.jar")
    into("${buildDir}/docker-jar")
    rename("inspectit-ocelot-eum-server-${version}\\.jar",
            "inspectit-ocelot-eum-server.jar")
}

docker {
    dependsOn copyServerJar
    name "inspectit/inspectit-ocelot-eum-server"
    tags "${version}"
    dockerfile file("docker/Dockerfile")
    files "docker/entrypoint.sh", "$buildDir/docker-jar/inspectit-ocelot-eum-server.jar"
}
